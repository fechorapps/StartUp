name: CI - Build & Test

on:
  push:
    branches: [ main, develop, 'feature/**', 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'DoorX.sln'
  BUILD_CONFIGURATION: 'Release'
  BUILD_OUTPUT: './build'
  ARTIFACTS_PATH: './artifacts'

jobs:
  build:
    name: Build Solution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: |
        dotnet build ${{ env.SOLUTION_FILE }} \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          /p:OutputPath=${{ env.BUILD_OUTPUT }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: ${{ env.BUILD_OUTPUT }}
        retention-days: 7

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Run Domain Unit Tests
      run: |
        dotnet test tests/Unit/Domain.UnitTests/Domain.UnitTests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --logger "trx;LogFileName=domain-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Run Application Unit Tests
      run: |
        dotnet test tests/Unit/Application.UnitTests/Application.UnitTests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --logger "trx;LogFileName=application-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Run Infrastructure Unit Tests
      run: |
        dotnet test tests/Unit/Infrastructure.UnitTests/Infrastructure.UnitTests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --logger "trx;LogFileName=infrastructure-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: '**/TestResults/**/*.trx'
        retention-days: 7

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-coverage
        path: '**/TestResults/**/coverage.opencover.xml'
        retention-days: 7

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: doorx
          POSTGRES_PASSWORD: doorx_test_password
          POSTGRES_DB: doorx_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Run API Integration Tests
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=doorx_test;Username=doorx;Password=doorx_test_password"
      run: |
        dotnet test tests/Integration/API.IntegrationTests/API.IntegrationTests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --logger "trx;LogFileName=api-integration-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Run Infrastructure Integration Tests
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=doorx_test;Username=doorx;Password=doorx_test_password"
      run: |
        dotnet test tests/Integration/Infrastructure.IntegrationTests/Infrastructure.IntegrationTests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --logger "trx;LogFileName=infrastructure-integration-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: '**/TestResults/**/*.trx'
        retention-days: 7

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-coverage
        path: '**/TestResults/**/coverage.opencover.xml'
        retention-days: 7

  publish:
    name: Publish & Package
    runs-on: ubuntu-latest
    needs: [build, test-unit, test-integration]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Publish API
      run: |
        dotnet publish src/API/API.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          --output ${{ env.BUILD_OUTPUT }}/api

    - name: Install 7zip
      run: sudo apt-get update && sudo apt-get install -y p7zip-full

    - name: Create artifacts directory
      run: mkdir -p ${{ env.ARTIFACTS_PATH }}

    - name: Compress deployment files
      run: |
        cd ${{ env.BUILD_OUTPUT }}/api
        7z a -t7z -mx=9 ../../${{ env.ARTIFACTS_PATH }}/doorx-api-${{ github.sha }}.7z .

    - name: Generate build info
      run: |
        cat > ${{ env.ARTIFACTS_PATH }}/build-info.txt <<EOF
        Build Information
        =================
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Commit Message: ${{ github.event.head_commit.message }}
        Author: ${{ github.actor }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Workflow: ${{ github.workflow }}
        Run Number: ${{ github.run_number }}
        EOF

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: ${{ env.ARTIFACTS_PATH }}/*
        retention-days: 30

    - name: Upload build output (uncompressed)
      uses: actions/upload-artifact@v4
      with:
        name: build-api
        path: ${{ env.BUILD_OUTPUT }}/api
        retention-days: 7

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, test-unit, test-integration, publish]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.test-unit.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.test-integration.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Publish | ${{ needs.publish.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
